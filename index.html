<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFL Pro-Tracker | Live Stats, Alerts & Persistence</title>
    <style>
        :root {
            --espn-red: #cc0000;
            --dark-bg: #0f0f0f;
            --card-bg: #1a1a1a;
            --accent-green: #00ff88;
            --text-main: #e0e0e0;
            --input-bg: #2a2a2a;
        }

        [data-theme="light"] {
            --dark-bg: #f4f4f4;
            --card-bg: #ffffff;
            --text-main: #1a1a1a;
            --input-bg: #eeeeee;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--dark-bg);
            color: var(--text-main);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            transition: background 0.3s ease;
        }

        #sidebar {
            width: 350px;
            background-color: var(--card-bg);
            padding: 25px;
            border-right: 1px solid #333;
            overflow-y: auto;
            box-shadow: 5px 0 15px rgba(0,0,0,0.2);
            z-index: 10;
            display: flex;
            flex-direction: column;
        }

        #live-stats {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .bet-card {
            background: var(--input-bg);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 6px solid var(--espn-red);
            position: relative;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .bet-card.winner {
            border-left-color: var(--accent-green);
            background: rgba(0, 255, 136, 0.1);
            animation: flash 1.5s infinite alternate;
        }

        @keyframes flash {
            from { box-shadow: 0 0 5px rgba(0, 255, 136, 0.1); }
            to { box-shadow: 0 0 20px rgba(0, 255, 136, 0.3); }
        }

        .game-info-bar {
            font-size: 0.8em;
            color: #888;
            background: rgba(0,0,0,0.1);
            padding: 5px 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            display: inline-block;
        }

        .stat-value { font-size: 2.5em; font-weight: 800; }

        .remove-btn {
            position: absolute; right: 15px; top: 15px;
            background: none; border: none; color: #888;
            cursor: pointer; font-size: 1.2em; width: auto !important;
        }

        label { display: block; margin-top: 15px; font-size: 0.75em; color: #888; text-transform: uppercase; font-weight: bold; }
        
        select, input, button {
            width: 100%; padding: 12px; margin-top: 5px;
            border-radius: 6px; border: 1px solid #444;
            background: var(--input-bg); color: var(--text-main);
            box-sizing: border-box;
        }

        button { background: var(--espn-red); color: white; border: none; font-weight: bold; cursor: pointer; margin-top: 20px; }
        button:hover { filter: brightness(1.2); }

        .progress-container { height: 8px; background: #333; border-radius: 4px; margin-top: 15px; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 1s ease; }

        .theme-toggle {
            margin-top: auto; padding-top: 20px;
            text-align: center; font-size: 0.8em; cursor: pointer; color: var(--espn-red);
        }

        .winner-badge {
            background: var(--accent-green); color: black;
            font-size: 0.7em; padding: 2px 8px; border-radius: 10px; margin-left: 10px;
        }
    </style>
</head>
<body>

<div id="sidebar">
    <h2 style="color:var(--espn-red); margin-top:0;">NFL TRACKER</h2>
    
    <label>Game</label>
    <select id="game-select" onchange="loadPlayers()"></select>

    <label>Player</label>
    <select id="player-select"></select>

    <label>Category</label>
    <select id="stat-category">
        <option value="rushingYards">Rushing Yards</option>
        <option value="passingYards">Passing Yards</option>
        <option value="receivingYards">Receiving Yards</option>
        <option value="receptions">Receptions</option>
    </select>

    <label>Line</label>
    <input type="number" id="bet-line" step="0.5" placeholder="e.g. 75.5">

    <button onclick="addBet()">START TRACKING</button>
    
    <div id="last-update" style="font-size: 0.7em; color: #666; margin-top: 20px; text-align: center;">Syncing...</div>
    
    <div class="theme-toggle" onclick="toggleTheme()">ðŸŒ“ Toggle Light/Dark Mode</div>
</div>

<div id="live-stats">
    <h1 id="header-title">Active Bets</h1>
    <div id="bets-container"></div>
</div>

<script>
    let myBets = JSON.parse(localStorage.getItem('nfl_bets')) || [];
    const BASE_URL = "https://site.api.espn.com/apis/site/v2/sports/football/nfl";
    const winSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2017/2017-preview.mp3');

    // 1. Initial Load
    window.onload = () => {
        fetchGames();
        updateUI();
        refreshStats();
        if(localStorage.getItem('theme') === 'light') toggleTheme(true);
    };

    async function fetchGames() {
        try {
            const res = await fetch(`${BASE_URL}/scoreboard`);
            const data = await res.json();
            const select = document.getElementById('game-select');
            select.innerHTML = '<option value="">-- Select Game --</option>';
            data.events.forEach(e => {
                const opt = document.createElement('option');
                opt.value = e.id;
                opt.textContent = `${e.name} (${e.status.type.shortDetail})`;
                select.appendChild(opt);
            });
        } catch (e) { console.error(e); }
    }

    async function loadPlayers() {
        const gameId = document.getElementById('game-select').value;
        const playerSelect = document.getElementById('player-select');
        playerSelect.innerHTML = '<option>Loading...</option>';
        const summaryRes = await fetch(`${BASE_URL}/summary?event=${gameId}`);
        const summaryData = await summaryRes.json();
        const teamIds = summaryData.header.competitions[0].competitors.map(c => c.id);

        let players = [];
        for (let id of teamIds) {
            const rosterRes = await fetch(`${BASE_URL}/teams/${id}/roster`);
            const rosterData = await rosterRes.json();
            rosterData.athletes.forEach(g => g.items.forEach(p => players.push({id: p.id, name: p.displayName, team: rosterData.team.abbreviation})));
        }
        players.sort((a,b) => a.name.localeCompare(b.name));
        playerSelect.innerHTML = '<option value="">-- Select Player --</option>';
        players.forEach(p => playerSelect.innerHTML += `<option value="${p.id}">${p.name} (${p.team})</option>`);
    }

    function addBet() {
        const gameId = document.getElementById('game-select').value;
        const playerId = document.getElementById('player-select').value;
        const playerName = document.getElementById('player-select').options[document.getElementById('player-select').selectedIndex].text;
        const category = document.getElementById('stat-category').value;
        const line = parseFloat(document.getElementById('bet-line').value);

        if(!gameId || !playerId || isNaN(line)) return alert("Fill all fields");

        myBets.push({ gameId, playerId, playerName, category, line, currentStat: 0, hasAlerted: false, gameStatus: 'Live' });
        saveAndRefresh();
    }

    async function refreshStats() {
        for (let bet of myBets) {
            try {
                const res = await fetch(`${BASE_URL}/summary?event=${bet.gameId}`);
                const data = await res.json();
                bet.gameStatus = data.header.competitions[0].status.type.shortDetail;
                if(data.situation) bet.lastPlay = data.situation.lastPlay?.text || "";

                let val = 0;
                data.boxscore.players.forEach(team => {
                    team.statistics.forEach(group => {
                        const athlete = group.athletes.find(a => a.athlete.id === bet.playerId);
                        if(athlete) {
                            const idx = group.labels.indexOf(getLabel(bet.category));
                            if(idx !== -1) val = parseFloat(athlete.stats[idx].toString().split('/')[0]) || 0;
                        }
                    });
                });
                if(val >= bet.line && !bet.hasAlerted) { winSound.play().catch(e => {}); bet.hasAlerted = true; }
                bet.currentStat = val;
            } catch (e) {}
        }
        saveAndRefresh();
        document.getElementById('last-update').textContent = "Updated: " + new Date().toLocaleTimeString();
    }

    function getLabel(cat) { return {rushingYards:"YDS", passingYards:"YDS", receivingYards:"YDS", receptions:"REC"}[cat]; }

    function saveAndRefresh() {
        localStorage.setItem('nfl_bets', JSON.stringify(myBets));
        updateUI();
    }

    function updateUI() {
        const container = document.getElementById('bets-container');
        container.innerHTML = myBets.length ? '' : '<p style="color:#666">No tracked bets.</p>';
        myBets.forEach((b, i) => {
            const isOver = b.currentStat >= b.line;
            container.innerHTML += `
                <div class="bet-card ${isOver ? 'winner' : ''}">
                    <button class="remove-btn" onclick="removeBet(${i})">âœ•</button>
                    <div class="game-info-bar">${b.gameStatus}</div>
                    <div style="font-weight:bold">${b.playerName} ${isOver ? '<span class="winner-badge">WINNER</span>' : ''}</div>
                    <div style="font-size:0.8em; color:#888">${b.category.toUpperCase()} | LINE: ${b.line}</div>
                    <div class="stat-value" style="color:${isOver ? 'var(--accent-green)' : 'inherit'}">${b.currentStat}</div>
                    <div class="progress-container"><div class="progress-fill" style="width:${Math.min((b.currentStat/b.line)*100, 100)}%; background:${isOver ? 'var(--accent-green)' : 'var(--espn-red)'}"></div></div>
                    <div style="font-size:0.7em; color:#666; margin-top:10px;">${b.lastPlay ? 'Last: ' + b.lastPlay.substring(0,80) : ''}</div>
                </div>`;
        });
    }

    function removeBet(i) { myBets.splice(i, 1); saveAndRefresh(); }

    function toggleTheme(init = false) {
        const body = document.body;
        if(!init) body.setAttribute('data-theme', body.getAttribute('data-theme') === 'light' ? 'dark' : 'light');
        else body.setAttribute('data-theme', 'light');
        localStorage.setItem('theme', body.getAttribute('data-theme'));
    }

    setInterval(refreshStats, 30000);
</script>
</body>
</html>
