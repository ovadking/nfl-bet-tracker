<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Prop Tracker v23</title>
    <style>
        :root { --red: #ff3e3e; --bg: #050505; --card: #121212; --green: #00ff88; --text: #eee; --yellow: #ffcc00; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        #sidebar { width: 380px; background: var(--card); padding: 25px; border-right: 1px solid #333; overflow-y: auto; box-shadow: 5px 0 15px rgba(0,0,0,0.5); }
        h2 { color: var(--red); font-size: 1.2rem; margin: 0 0 20px 0; letter-spacing: 2px; text-transform: uppercase; }
        .builder { background: #1a1a1a; padding: 15px; border-radius: 12px; border: 1px solid #333; }
        label { font-size: 0.65rem; color: #888; font-weight: 800; margin-top: 15px; display: block; text-transform: uppercase; }
        select, input, button { width: 100%; padding: 12px; margin-top: 5px; border-radius: 8px; border: 1px solid #444; background: #222; color: #fff; font-size: 0.9rem; outline: none; transition: 0.2s; }
        select:focus, input:focus { border-color: var(--red); }
        .btn-add { background: var(--red); border: none; font-weight: 900; cursor: pointer; margin-top: 20px; height: 50px; }
        #main { flex-grow: 1; padding: 40px; overflow-y: auto; background: radial-gradient(circle at top right, #111, #050505); }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px; }
        .parlay-card { background: var(--card); border-radius: 20px; border: 1px solid #333; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .leg { padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .leg.hit { background: rgba(0, 255, 136, 0.05); }
        .remove-btn { color: #555; cursor: pointer; font-size: 0.8rem; margin-left: 10px; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>Tracker Pro v23</h2>
    <button onclick="Notification.requestPermission()" style="background:transparent; border:1px solid var(--yellow); color:var(--yellow); font-size:0.7rem; cursor:pointer;">ðŸ”” ENABLE ALERTS</button>

    <div class="builder">
        <label>1. Sport</label>
        <select id="sport" onchange="updateStatOptions(); loadGames();">
            <option value="basketball/nba">NBA Basketball</option>
            <option value="football/nfl">NFL Football</option>
        </select>

        <label>2. Select Game</label>
        <select id="game-select" onchange="fetchRoster()"></select>

        <label>3. Select Player</label>
        <select id="player-select"></select>

        <label>4. Stat & Target</label>
        <div style="display:flex; gap:8px;">
            <select id="stat-type" style="flex:1.8;"></select>
            <input type="number" id="target" step="0.5" placeholder="Line" style="flex:1;">
        </div>

        <button class="btn-add" onclick="finalizeTracker()">DEPLOY TRACKER</button>
    </div>
</div>

<div id="main">
    <div id="display-grid" class="grid"></div>
</div>

<script>
    let activeTrackers = JSON.parse(localStorage.getItem('props_v23')) || [];

    const statsConfig = {
        "basketball/nba": [
            { label: "Points", val: "PTS" },
            { label: "Rebounds", val: "REB" },
            { label: "Assists", val: "AST" },
            { label: "Three Pointers", val: "3PM" }
        ],
        "football/nfl": [
            { label: "Pass Yards", val: "PY" },
            { label: "Rush Yards", val: "RY" },
            { label: "Rec Yards", val: "REY" },
            { label: "Receptions", val: "REC" },
            { label: "Touchdowns", val: "TD" }
        ]
    };

    function updateStatOptions() {
        const sport = document.getElementById('sport').value;
        const statSelect = document.getElementById('stat-type');
        statSelect.innerHTML = statsConfig[sport].map(s => `<option value="${s.val}">${s.label}</option>`).join('');
    }

    async function loadGames() {
        const sport = document.getElementById('sport').value;
        const res = await fetch(`https://site.api.espn.com/apis/site/v2/sports/${sport}/scoreboard`);
        const data = await res.json();
        const select = document.getElementById('game-select');
        
        select.innerHTML = data.events.map(e => {
            const t1 = e.competitions[0].competitors[0].team.id;
            const t2 = e.competitions[0].competitors[1].team.id;
            return `<option value="${e.id}" data-t1="${t1}" data-t2="${t2}">${e.shortName}</option>`;
        }).join('');
        fetchRoster();
    }

    async function fetchRoster() {
        const sport = document.getElementById('sport').value;
        const gameOpt = document.getElementById('game-select').selectedOptions[0];
        const playerSel = document.getElementById('player-select');
        playerSel.innerHTML = "<option>Loading...</option>";

        try {
            const [r1, r2] = await Promise.all([
                fetch(`https://site.api.espn.com/apis/site/v2/sports/${sport}/teams/${gameOpt.dataset.t1}/roster`),
                fetch(`https://site.api.espn.com/apis/site/v2/sports/${sport}/teams/${gameOpt.dataset.t2}/roster`)
            ]);
            const [d1, d2] = await Promise.all([r1.json(), r2.json()]);
            const allPlayers = [...d1.athletes.flatMap(g => g.items), ...d2.athletes.flatMap(g => g.items)];
            playerSel.innerHTML = allPlayers.sort((a,b)=>a.displayName.localeCompare(b.displayName)).map(p => `<option value="${p.id}">${p.displayName}</option>`).join('');
        } catch (e) { playerSel.innerHTML = "<option>Error loading</option>"; }
    }

    function finalizeTracker() {
        const p = document.getElementById('player-select');
        const target = parseFloat(document.getElementById('target').value);
        if (!target) return alert("Set a line!");

        activeTrackers.push({
            id: p.value,
            name: p.options[p.selectedIndex].text,
            gameId: document.getElementById('game-select').value,
            sport: document.getElementById('sport').value,
            type: document.getElementById('stat-type').value,
            target: target,
            current: 0, hit: false, notified: false
        });
        save();
    }

    async function updateData() {
        for (let prop of activeTrackers) {
            try {
                const res = await fetch(`https://site.api.espn.com/apis/site/v2/sports/${prop.sport}/summary?event=${prop.gameId}`);
                const data = await res.json();
                
                // Map local prop names to ESPN API labels
                const labelMap = { 
                    "PTS": "PTS", "REB": "REB", "AST": "AST", 
                    "PY": "YDS", "RY": "YDS", "REY": "YDS", "REC": "REC", "TD": "TD" 
                };

                data.boxscore?.players?.forEach(team => {
                    // NFL API separates Passing, Rushing, Receiving into different statistic blocks
                    team.statistics.forEach(statGroup => {
                        const athlete = statGroup.athletes.find(a => a.athlete.id === prop.id);
                        if (athlete) {
                            const idx = statGroup.labels.indexOf(labelMap[prop.type]);
                            if (idx !== -1) {
                                prop.current = parseFloat(athlete.stats[idx]) || 0;
                                if (prop.current >= prop.target) {
                                    prop.hit = true;
                                    if (!prop.notified && Notification.permission === "granted") {
                                        new Notification("ðŸ’° HIT!", { body: `${prop.name} hit ${prop.target} ${prop.type}` });
                                        prop.notified = true;
                                    }
                                }
                            }
                        }
                    });
                });
            } catch (e) {}
        }
        render();
    }

    function render() {
        document.getElementById('display-grid').innerHTML = activeTrackers.map((p, i) => `
            <div class="parlay-card">
                <div style="background:#1a1a1a; padding:10px; font-size:0.6rem; display:flex; justify-content:space-between;">
                    <span>LIVE TRACKER</span>
                    <span class="remove-btn" onclick="remove(${i})">REMOVE</span>
                </div>
                <div class="leg ${p.hit ? 'hit' : ''}">
                    <div><strong>${p.name}</strong><br><small>${p.target} ${p.type}</small></div>
                    <div style="font-size:1.5rem; font-weight:900; color:${p.hit?'var(--green)':'#fff'}">${p.current}</div>
                </div>
            </div>
        `).join('');
    }

    function save() { localStorage.setItem('props_v23', JSON.stringify(activeTrackers)); render(); }
    function remove(i) { activeTrackers.splice(i, 1); save(); }

    updateStatOptions();
    loadGames();
    setInterval(updateData, 15000);
</script>
</body>
</html>
