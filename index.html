<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Prop Tracker v21 - Pre-Game Fix</title>
    <style>
        :root { --red: #ff3e3e; --bg: #0a0a0a; --card: #181818; --green: #00ff88; --text: #ffffff; --yellow: #ffcc00; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        #sidebar { width: 380px; background: var(--card); padding: 20px; border-right: 1px solid #333; overflow-y: auto; }
        h2 { color: var(--red); font-size: 1.1rem; margin-bottom: 20px; letter-spacing: 2px; }
        label { font-size: 0.6rem; color: #777; font-weight: 800; margin-top: 15px; display: block; text-transform: uppercase; }
        select, input, button { width: 100%; padding: 12px; margin-top: 5px; border-radius: 8px; border: 1px solid #333; background: #222; color: #fff; font-size: 0.85rem; box-sizing: border-box; }
        .builder-box { background: #111; padding: 15px; border-radius: 12px; border: 1px solid #333; margin-top: 10px; }
        .btn-add-leg { background: #333; color: var(--green); border: 1px solid var(--green); cursor: pointer; font-weight: bold; margin-top: 10px; }
        .btn-finalize { background: var(--green); color: #000; border: none; font-weight: 900; cursor: pointer; height: 45px; margin-top: 15px; }
        #main { flex-grow: 1; padding: 30px; overflow-y: auto; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 25px; }
        .parlay-card { background: var(--card); border-radius: 16px; border: 2px solid #333; overflow: hidden; margin-bottom: 20px; }
        .leg { padding: 15px 20px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
        .leg.hit { background: rgba(0, 255, 136, 0.08); }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>PROP TRACKER v21</h2>
    
    <button onclick="injectBullsHawks()" style="background:#444; color:var(--yellow); font-size:0.7rem; margin-bottom:10px;">âš¡ EMERGENCY: LOAD BULLS @ HAWKS</button>
    <button onclick="Notification.requestPermission()" style="background:var(--yellow); color:#000; font-weight:bold;">ðŸ”” ENABLE NOTIFICATIONS</button>

    <div class="builder-box">
        <label>1. Sport</label>
        <select id="sport-select" onchange="loadGames()">
            <option value="basketball/nba">NBA</option>
            <option value="football/nfl">NFL</option>
        </select>

        <label>2. Game (Today)</label>
        <select id="game-select" onchange="loadTeamRosters()"></select>

        <label>3. Player</label>
        <select id="player-select"></select>

        <label>4. Target</label>
        <div style="display:flex; gap:5px;">
            <select id="stat-type" style="flex:1.5;"><option value="PTS">Points</option><option value="REB">Rebounds</option><option value="AST">Assists</option></select>
            <input type="number" id="target-val" step="0.5" placeholder="Line">
        </div>
        
        <button class="btn-add-leg" onclick="addLeg()">+ ADD TO PARLAY</button>
        <div id="draft-list" style="font-size:0.7rem; color:var(--yellow); margin:10px 0;"></div>
        <button class="btn-finalize" onclick="finalizeParlay()">ðŸš€ DEPLOY PARLAY</button>
    </div>
</div>

<div id="main"><div id="parlay-grid" class="grid"></div></div>

<script>
    let activeParlays = JSON.parse(localStorage.getItem('parlays_v21')) || [];
    let draftLegs = [];

    // Emergency Injector for Bulls vs Hawks
    function injectBullsHawks() {
        const players = [
            { id: "4277811", name: "Trae Young (ATL)" },
            { id: "4395627", name: "Jalen Johnson (ATL)" },
            { id: "4278104", name: "Josh Giddey (CHI)" },
            { id: "4277883", name: "Coby White (CHI)" },
            { id: "3056600", name: "Nikola Vucevic (CHI)" }
        ];
        const pSel = document.getElementById('player-select');
        pSel.innerHTML = players.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        // This is the Game ID for Bulls @ Hawks today Dec 23
        document.getElementById('game-select').innerHTML = `<option value="401705030">Bulls @ Hawks</option>`;
    }

    async function loadGames() {
        const sport = document.getElementById('sport-select').value;
        const res = await fetch(`https://site.api.espn.com/apis/site/v2/sports/${sport}/scoreboard`);
        const data = await res.json();
        const select = document.getElementById('game-select');
        select.innerHTML = data.events.map(e => `<option value="${e.id}">${e.shortName}</option>`).join('');
        loadTeamRosters();
    }

    async function loadTeamRosters() {
        const sport = document.getElementById('sport-select').value;
        const gameId = document.getElementById('game-select').value;
        const pSelect = document.getElementById('player-select');
        pSelect.innerHTML = "<option>Loading...</option>";

        // Fetching from the Summary first as it's the most reliable for current active rosters
        try {
            const res = await fetch(`https://site.api.espn.com/apis/site/v2/sports/${sport}/summary?event=${gameId}`);
            const data = await res.json();
            
            // If the game hasn't started, ESPN summary might be empty. 
            // We use a fallback to search by team if empty.
            if (!data.boxscore || !data.boxscore.players) {
                pSelect.innerHTML = "<option>Roster not yet released by ESPN. Use Emergency Button for Bulls/Hawks.</option>";
                return;
            }

            let players = [];
            data.boxscore.players.forEach(team => {
                team.statistics[0].athletes.forEach(a => {
                    players.push({ id: a.athlete.id, name: a.athlete.displayName });
                });
            });
            pSelect.innerHTML = players.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        } catch (e) { pSelect.innerHTML = "<option>Error loading roster</option>"; }
    }

    function addLeg() {
        const p = document.getElementById('player-select');
        const target = parseFloat(document.getElementById('target-val').value);
        if (isNaN(target)) return;
        draftLegs.push({
            id: p.value,
            name: p.options[p.selectedIndex].text,
            gameId: document.getElementById('game-select').value,
            sport: document.getElementById('sport-select').value,
            type: document.getElementById('stat-type').value,
            target: target,
            current: 0, hit: false
        });
        document.getElementById('draft-list').innerHTML = draftLegs.map(l => `<div>â€¢ ${l.name} ${l.target} ${l.type}</div>`).join('');
    }

    function finalizeParlay() {
        activeParlays.push({ id: Date.now(), legs: [...draftLegs], won: false });
        draftLegs = [];
        document.getElementById('draft-list').innerHTML = "";
        save();
    }

    async function updateStats() {
        for (let parlay of activeParlays) {
            let allHit = true;
            for (let leg of parlay.legs) {
                try {
                    const res = await fetch(`https://site.api.espn.com/apis/site/v2/sports/${leg.sport}/summary?event=${leg.gameId}`);
                    const data = await res.json();
                    data.boxscore?.players?.forEach(t => {
                        const stats = t.statistics[0];
                        const athlete = stats.athletes.find(a => a.athlete.id === leg.id);
                        if (athlete) {
                            const idx = stats.labels.indexOf(leg.type);
                            leg.current = parseFloat(athlete.stats[idx]) || 0;
                            if (leg.current >= leg.target) leg.hit = true;
                        }
                    });
                } catch(e){}
                if(!leg.hit) allHit = false;
            }
            if(allHit && !parlay.won) {
                parlay.won = true;
                new Notification("ðŸ’° PARLAY HIT!");
            }
        }
        render();
    }

    function render() {
        document.getElementById('parlay-grid').innerHTML = activeParlays.map((parlay, idx) => `
            <div class="parlay-card">
                <div style="background:#222; padding:10px;">${parlay.legs.length}-LEG PARLAY <span onclick="removeParlay(${idx})" style="float:right; color:red; cursor:pointer;">X</span></div>
                ${parlay.legs.map(l => `<div class="leg ${l.hit ? 'hit' : ''}">
                    <div>${l.name} (${l.target} ${l.type})</div>
                    <div style="font-weight:900; color:${l.hit ? 'var(--green)' : 'white'}">${l.current}</div>
                </div>`).join('')}
            </div>
        `).join('');
    }

    function save() { localStorage.setItem('parlays_v21', JSON.stringify(activeParlays)); render(); }
    function removeParlay(i) { activeParlays.splice(i, 1); save(); }

    loadGames();
    setInterval(updateStats, 15000);
</script>
</body>
</html>
