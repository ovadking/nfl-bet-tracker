<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFL Pro-Tracker | Full Control</title>
    <style>
        :root {
            --espn-red: #cc0000;
            --dark-bg: #0f0f0f;
            --card-bg: #1a1a1a;
            --accent-green: #00ff88;
            --text-main: #e0e0e0;
            --input-bg: #2a2a2a;
        }

        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            background-color: var(--dark-bg);
            color: var(--text-main);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        #sidebar {
            width: 350px;
            background-color: var(--card-bg);
            padding: 25px;
            border-right: 1px solid #444;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        #live-stats {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .summary-banner {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-around;
            border: 1px solid #444;
        }

        .summary-stat { text-align: center; }
        .summary-stat span { display: block; font-size: 1.5em; font-weight: bold; }

        .bet-card {
            background: var(--input-bg);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 6px solid var(--espn-red);
            position: relative;
        }

        .bet-card.winner {
            border-left-color: var(--accent-green);
            background: rgba(0, 255, 136, 0.05);
        }

        .search-input {
            background: #111;
            border: 1px solid var(--espn-red);
            font-size: 0.85em;
            padding: 8px;
            border-radius: 6px 6px 0 0;
            margin-top: 5px;
        }

        label { display: block; margin-top: 15px; font-size: 0.75em; color: #888; text-transform: uppercase; font-weight: bold; }
        
        select, input, button {
            width: 100%; padding: 12px; margin-top: 5px;
            border-radius: 6px; border: 1px solid #444;
            background: var(--input-bg); color: var(--text-main);
            box-sizing: border-box;
        }

        .btn-main { background: var(--espn-red); color: white; border: none; font-weight: bold; cursor: pointer; margin-top: 20px; height: 50px; }
        
        .control-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-secondary {
            background: #333;
            color: #ccc;
            font-size: 0.75em;
            padding: 10px;
            border: 1px solid #555;
            cursor: pointer;
        }

        .btn-reset {
            background: #441111;
            color: #ff6666;
            border-color: #772222;
        }

        .progress-container { height: 8px; background: #333; border-radius: 4px; margin-top: 15px; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 1s ease; }

        .winner-badge {
            background: var(--accent-green); color: black;
            font-size: 0.7em; padding: 2px 8px; border-radius: 10px; margin-left: 10px;
        }

        .remove-btn {
            position: absolute; right: 15px; top: 15px;
            background: none; border: none; color: #888;
            cursor: pointer; font-size: 1.2em; width: auto !important;
        }
    </style>
</head>
<body>

<div id="sidebar">
    <h2 style="color:var(--espn-red); margin-top:0;">NFL TRACKER</h2>
    
    <label>1. Select Game</label>
    <select id="game-select" onchange="loadPlayers()"></select>

    <label>2. Search Player</label>
    <input type="text" id="player-search" class="search-input" placeholder="Type to filter..." onkeyup="filterPlayers()">
    <select id="player-select" size="5" style="border-radius: 0 0 6px 6px; margin-top:0;"></select>

    <label>3. Category</label>
    <select id="stat-category">
        <option value="rushingYards">Rushing Yards</option>
        <option value="passingYards">Passing Yards</option>
        <option value="receivingYards">Receiving Yards</option>
        <option value="receptions">Receptions</option>
    </select>

    <label>4. Your Line</label>
    <input type="number" id="bet-line" step="0.5" placeholder="e.g. 75.5">

    <button class="btn-main" onclick="addBet()">TRACK NEW PROP</button>

    <div class="control-group">
        <button class="btn-secondary" onclick="manualSave()">üíæ SAVE DATA</button>
        <button class="btn-secondary btn-reset" onclick="resetAll()">üóëÔ∏è RESET ALL</button>
    </div>
    
    <div id="last-update" style="font-size: 0.7em; color: #666; margin-top: 20px; text-align: center;">Syncing with ESPN...</div>
</div>

<div id="live-stats">
    <div class="summary-banner">
        <div class="summary-stat">WINS <span id="total-wins" style="color:var(--accent-green)">0</span></div>
        <div class="summary-stat">ACTIVE <span id="total-active">0</span></div>
        <div class="summary-stat">TOTAL <span id="total-bets">0</span></div>
    </div>
    <div id="bets-container"></div>
</div>

<script>
    let myBets = JSON.parse(localStorage.getItem('nfl_bets')) || [];
    let fullRoster = [];
    const BASE_URL = "https://site.api.espn.com/apis/site/v2/sports/football/nfl";
    const winSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2017/2017-preview.mp3');

    window.onload = () => {
        fetchGames();
        updateUI();
        refreshStats();
    };

    async function fetchGames() {
        const res = await fetch(`${BASE_URL}/scoreboard`);
        const data = await res.json();
        const select = document.getElementById('game-select');
        select.innerHTML = '<option value="">-- Select Game --</option>';
        data.events.forEach(e => select.innerHTML += `<option value="${e.id}">${e.name} (${e.status.type.shortDetail})</option>`);
    }

    async function loadPlayers() {
        const gameId = document.getElementById('game-select').value;
        const res = await fetch(`${BASE_URL}/summary?event=${gameId}`);
        const data = await res.json();
        const teamIds = data.header.competitions[0].competitors.map(c => c.id);

        fullRoster = [];
        for (let id of teamIds) {
            const rosterRes = await fetch(`${BASE_URL}/teams/${id}/roster`);
            const rosterData = await rosterRes.json();
            rosterData.athletes.forEach(g => g.items.forEach(p => fullRoster.push({id: p.id, name: p.displayName, team: rosterData.team.abbreviation})));
        }
        fullRoster.sort((a,b) => a.name.localeCompare(b.name));
        renderPlayerList(fullRoster);
    }

    function renderPlayerList(list) {
        const select = document.getElementById('player-select');
        select.innerHTML = list.map(p => `<option value="${p.id}">${p.name} (${p.team})</option>`).join('');
    }

    function filterPlayers() {
        const term = document.getElementById('player-search').value.toLowerCase();
        renderPlayerList(fullRoster.filter(p => p.name.toLowerCase().includes(term)));
    }

    function addBet() {
        const gameId = document.getElementById('game-select').value;
        const pSelect = document.getElementById('player-select');
        const playerId = pSelect.value;
        const playerName = pSelect.options[pSelect.selectedIndex]?.text;
        const category = document.getElementById('stat-category').value;
        const line = parseFloat(document.getElementById('bet-line').value);

        if(!gameId || !playerId || isNaN(line)) return alert("Missing fields");

        myBets.push({ gameId, playerId, playerName, category, line, currentStat: 0, hasAlerted: false, gameStatus: 'Live' });
        manualSave();
    }

    async function refreshStats() {
        for (let bet of myBets) {
            try {
                const res = await fetch(`${BASE_URL}/summary?event=${bet.gameId}`);
                const data = await res.json();
                bet.gameStatus = data.header.competitions[0].status.type.shortDetail;
                if(data.situation) bet.lastPlay = data.situation.lastPlay?.text || "";

                let val = 0;
                data.boxscore.players.forEach(team => {
                    team.statistics.forEach(group => {
                        const athlete = group.athletes.find(a => a.athlete.id === bet.playerId);
                        if(athlete) {
                            const labels = group.labels;
                            const idx = labels.indexOf({rushingYards:"YDS", passingYards:"YDS", receivingYards:"YDS", receptions:"REC"}[bet.category]);
                            if(idx !== -1) val = parseFloat(athlete.stats[idx].toString().split('/')[0]) || 0;
                        }
                    });
                });
                if(val >= bet.line && !bet.hasAlerted) { winSound.play().catch(e => {}); bet.hasAlerted = true; }
                bet.currentStat = val;
            } catch (e) {}
        }
        updateUI();
        document.getElementById('last-update').textContent = "Updated: " + new Date().toLocaleTimeString();
    }

    function updateUI() {
        const container = document.getElementById('bets-container');
        container.innerHTML = myBets.length ? '' : '<p style="color:#555">No active bets.</p>';
        
        let wins = 0;
        myBets.forEach((b, i) => {
            const isOver = b.currentStat >= b.line;
            if(isOver) wins++;
            container.innerHTML += `
                <div class="bet-card ${isOver ? 'winner' : ''}">
                    <button class="remove-btn" onclick="removeBet(${i})">‚úï</button>
                    <div class="game-info-bar">${b.gameStatus}</div>
                    <div style="font-weight:bold">${b.playerName} ${isOver ? '<span class="winner-badge">WINNER</span>' : ''}</div>
                    <div style="font-size:0.8em; color:#888">${b.category.toUpperCase()} | LINE: ${b.line}</div>
                    <div class="stat-value">${b.currentStat}</div>
                    <div class="progress-container">
                        <div class="progress-fill" style="width:${Math.min((b.currentStat/b.line)*100, 100)}%; background:${isOver ? 'var(--accent-green)' : 'var(--espn-red)'}"></div>
                    </div>
                </div>`;
        });
        document.getElementById('total-wins').textContent = wins;
        document.getElementById('total-active').textContent = myBets.length - wins;
        document.getElementById('total-bets').textContent = myBets.length;
    }

    function manualSave() {
        localStorage.setItem('nfl_bets', JSON.stringify(myBets));
        updateUI();
    }

    function resetAll() {
        if(confirm("Wipe all active bets and start over?")) {
            myBets = [];
            localStorage.removeItem('nfl_bets');
            updateUI();
        }
    }

    function removeBet(i) {
        myBets.splice(i, 1);
        manualSave();
    }

    setInterval(refreshStats, 30000);
</script>
</body>
</html>
