<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Sport Live Tracker</title>
    <style>
        :root {
            --espn-red: #cc0000;
            --dark-bg: #0f0f0f;
            --card-bg: #1a1a1a;
            --accent-green: #00ff88;
            --text-main: #e0e0e0;
            --input-bg: #2a2a2a;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--dark-bg); color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        #sidebar { width: 350px; background-color: var(--card-bg); padding: 25px; border-right: 1px solid #444; overflow-y: auto; display: flex; flex-direction: column; }
        #live-stats { flex-grow: 1; padding: 30px; overflow-y: auto; }
        .summary-banner { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin-bottom: 25px; display: flex; justify-content: space-around; border: 1px solid #444; }
        .bet-card { background: var(--input-bg); padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 6px solid var(--espn-red); position: relative; }
        .bet-card.winner { border-left-color: var(--accent-green); background: rgba(0, 255, 136, 0.05); }
        label { display: block; margin-top: 15px; font-size: 0.75em; color: #888; text-transform: uppercase; font-weight: bold; }
        select, input, button { width: 100%; padding: 12px; margin-top: 5px; border-radius: 6px; border: 1px solid #444; background: var(--input-bg); color: var(--text-main); box-sizing: border-box; }
        .btn-main { background: var(--espn-red); color: white; border: none; font-weight: bold; cursor: pointer; margin-top: 20px; height: 50px; }
        .control-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .btn-secondary { background: #333; color: #ccc; font-size: 0.75em; padding: 10px; border: 1px solid #555; cursor: pointer; }
        .progress-container { height: 8px; background: #333; border-radius: 4px; margin-top: 15px; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 1s ease; }
        .remove-btn { position: absolute; right: 15px; top: 15px; background: none; border: none; color: #888; cursor: pointer; font-size: 1.2em; width: auto !important; }
        .sport-badge { font-size: 0.7em; background: #444; padding: 2px 6px; border-radius: 4px; margin-bottom: 5px; display: inline-block; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2 style="color:var(--espn-red); margin-top:0;">PRO-TRACKER</h2>
    
    <label>Select Sport</label>
    <select id="sport-select" onchange="fetchGames()">
        <option value="football/nfl">NFL Football</option>
        <option value="basketball/nba">NBA Basketball</option>
        <option value="baseball/mlb">MLB Baseball</option>
        <option value="tennis/atp">Tennis (ATP)</option>
    </select>

    <label>1. Select Game</label>
    <select id="game-select" onchange="loadPlayers()"></select>

    <label>2. Search Player</label>
    <input type="text" id="player-search" placeholder="Type to filter..." onkeyup="filterPlayers()" style="border-bottom:none; border-radius: 6px 6px 0 0;">
    <select id="player-select" size="5" style="border-radius: 0 0 6px 6px; margin-top:0;"></select>

    <label>3. Category</label>
    <select id="stat-category"></select>

    <label>4. Your Line</label>
    <input type="number" id="bet-line" step="0.5" placeholder="e.g. 25.5">

    <button class="btn-main" onclick="addBet()">TRACK PROP</button>

    <div class="control-group">
        <button class="btn-secondary" onclick="manualSave()">üíæ SAVE</button>
        <button class="btn-secondary" style="color:#ff6666" onclick="resetAll()">üóëÔ∏è RESET</button>
    </div>
</div>

<div id="live-stats">
    <div class="summary-banner">
        <div style="text-align:center">WINS <span id="total-wins" style="color:var(--accent-green); display:block; font-size:1.5em;">0</span></div>
        <div style="text-align:center">ACTIVE <span id="total-active" style="display:block; font-size:1.5em;">0</span></div>
    </div>
    <div id="bets-container"></div>
</div>

<script>
    let myBets = JSON.parse(localStorage.getItem('multi_sport_bets')) || [];
    let fullRoster = [];
    const winSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2017/2017-preview.mp3');

    const statMap = {
        "football/nfl": { "rushingYards": "YDS", "passingYards": "YDS", "receivingYards": "YDS", "receptions": "REC" },
        "basketball/nba": { "points": "PTS", "rebounds": "REB", "assists": "AST", "threePointersMade": "3PM" },
        "baseball/mlb": { "hits": "H", "homeRuns": "HR", "strikeouts": "K", "rbi": "RBI" },
        "tennis/atp": { "aces": "Aces", "doubleFaults": "DF", "firstServePoints": "1st Serve %" }
    };

    window.onload = () => { updateStatCategories(); fetchGames(); updateUI(); setInterval(refreshStats, 30000); };

    function updateStatCategories() {
        const sport = document.getElementById('sport-select').value;
        const catSelect = document.getElementById('stat-category');
        catSelect.innerHTML = Object.keys(statMap[sport]).map(k => `<option value="${k}">${k.replace(/([A-Z])/g, ' $1').toUpperCase()}</option>`).join('');
    }

    async function fetchGames() {
        updateStatCategories();
        const sport = document.getElementById('sport-select').value;
        const res = await fetch(`https://site.api.espn.com/apis/site/v2/sports/${sport}/scoreboard`);
        const data = await res.json();
        const select = document.getElementById('game-select');
        select.innerHTML = '<option value="">-- Select Game --</option>';
        data.events.forEach(e => select.innerHTML += `<option value="${e.id}">${e.name}</option>`);
    }

    async function loadPlayers() {
        const sport = document.getElementById('sport-select').value;
        const gameId = document.getElementById('game-select').value;
        const res = await fetch(`https://site.api.espn.com/apis/site/v2/sports/${sport}/summary?event=${gameId}`);
        const data = await res.json();
        
        fullRoster = [];
        // Handle Tennis (Athletes are in the competitors array directly usually)
        if (sport.includes('tennis')) {
            data.header.competitions[0].competitors.forEach(c => {
                fullRoster.push({id: c.id, name: c.team.displayName, team: ''});
            });
        } else {
            const teamIds = data.header.competitions[0].competitors.map(c => c.id);
            for (let id of teamIds) {
                const rRes = await fetch(`https://site.api.espn.com/apis/site/v2/sports/${sport}/teams/${id}/roster`);
                const rData = await rRes.json();
                rData.athletes.forEach(g => g.items.forEach(p => fullRoster.push({id: p.id, name: p.displayName, team: rData.team.abbreviation})));
            }
        }
        renderPlayerList(fullRoster);
    }

    function renderPlayerList(list) {
        document.getElementById('player-select').innerHTML = list.map(p => `<option value="${p.id}">${p.name} ${p.team ? '('+p.team+')' : ''}</option>`).join('');
    }

    function filterPlayers() {
        const term = document.getElementById('player-search').value.toLowerCase();
        renderPlayerList(fullRoster.filter(p => p.name.toLowerCase().includes(term)));
    }

    function addBet() {
        const sport = document.getElementById('sport-select').value;
        const pSel = document.getElementById('player-select');
        myBets.push({
            sport,
            gameId: document.getElementById('game-select').value,
            playerId: pSel.value,
            playerName: pSel.options[pSel.selectedIndex].text,
            category: document.getElementById('stat-category').value,
            line: parseFloat(document.getElementById('bet-line').value),
            currentStat: 0, hasAlerted: false
        });
        manualSave();
    }

    async function refreshStats() {
        for (let bet of myBets) {
            try {
                const res = await fetch(`https://site.api.espn.com/apis/site/v2/sports/${bet.sport}/summary?event=${bet.gameId}`);
                const data = await res.json();
                let val = 0;
                const label = statMap[bet.sport][bet.category];

                data.boxscore.players.forEach(team => {
                    team.statistics.forEach(group => {
                        const athlete = group.athletes.find(a => a.athlete.id === bet.playerId);
                        if(athlete) {
                            const idx = group.labels.indexOf(label);
                            if(idx !== -1) val = parseFloat(athlete.stats[idx]) || 0;
                        }
                    });
                });
                if(val >= bet.line && !bet.hasAlerted) { winSound.play().catch(e=>{}); bet.hasAlerted = true; }
                bet.currentStat = val;
            } catch (e) {}
        }
        updateUI();
    }

    function updateUI() {
        const container = document.getElementById('bets-container');
        container.innerHTML = '';
        let wins = 0;
        myBets.forEach((b, i) => {
            const isOver = b.currentStat >= b.line;
            if(isOver) wins++;
            container.innerHTML += `
                <div class="bet-card ${isOver ? 'winner' : ''}">
                    <button class="remove-btn" onclick="removeBet(${i})">‚úï</button>
                    <span class="sport-badge">${b.sport.split('/')[1].toUpperCase()}</span>
                    <div style="font-weight:bold">${b.playerName}</div>
                    <div style="font-size:0.8em; color:#888">${b.category.toUpperCase()} | LINE: ${b.line}</div>
                    <div style="font-size:2em; font-weight:800; color:${isOver?'var(--accent-green)':'#fff'}">${b.currentStat}</div>
                    <div class="progress-container"><div class="progress-fill" style="width:${Math.min((b.currentStat/b.line)*100, 100)}%; background:${isOver?'var(--accent-green)':'var(--espn-red)'}"></div></div>
                </div>`;
        });
        document.getElementById('total-wins').textContent = wins;
        document.getElementById('total-active').textContent = myBets.length - wins;
    }

    function manualSave() { localStorage.setItem('multi_sport_bets', JSON.stringify(myBets)); updateUI(); }
    function resetAll() { if(confirm("Clear all bets?")) { myBets = []; manualSave(); } }
    function removeBet(i) { myBets.splice(i, 1); manualSave(); }
</script>
</body>
</html>
