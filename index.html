<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Prop Picker & Live Tracker</title>
    <style>
        :root {
            --espn-red: #cc0000;
            --dark-bg: #0b0b0b;
            --card-bg: #161616;
            --accent-green: #00ff88;
            --text-main: #f0f0f0;
            --input-bg: #222222;
        }
        body { font-family: 'Inter', 'Segoe UI', sans-serif; background-color: var(--dark-bg); color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar Styling */
        #sidebar { width: 380px; background-color: var(--card-bg); padding: 20px; border-right: 1px solid #333; overflow-y: auto; box-shadow: 5px 0 15px rgba(0,0,0,0.5); }
        h2 { color: var(--espn-red); letter-spacing: 2px; margin-top: 0; font-size: 1.4em; }
        
        /* Main View Styling */
        #main-view { flex-grow: 1; padding: 25px; overflow-y: auto; background: radial-gradient(circle at top right, #1a1a1a, #0b0b0b); }
        
        /* Controls */
        label { display: block; margin-top: 15px; font-size: 0.7em; color: #888; text-transform: uppercase; font-weight: 800; }
        select, input, button { width: 100%; padding: 12px; margin-top: 5px; border-radius: 6px; border: 1px solid #333; background: var(--input-bg); color: white; font-size: 0.9em; }
        .btn-research { background: transparent; border: 1px solid var(--accent-green); color: var(--accent-green); cursor: pointer; transition: 0.3s; margin-top: 15px; font-weight: bold; }
        .btn-research:hover { background: var(--accent-green); color: black; }
        .btn-add { background: var(--espn-red); border: none; font-weight: bold; cursor: pointer; margin-top: 20px; height: 50px; }
        
        /* Research Box */
        .research-card { background: #000; border: 1px solid #444; padding: 15px; border-radius: 8px; margin-top: 15px; display: none; }
        .res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0; }
        .res-item { background: #1a1a1a; padding: 10px; border-radius: 4px; text-align: center; border-bottom: 2px solid var(--accent-green); }
        
        /* Bet Cards */
        .bet-card { background: var(--card-bg); padding: 20px; border-radius: 15px; margin-bottom: 20px; border-left: 6px solid var(--espn-red); position: relative; animation: slideIn 0.3s ease-out; }
        .bet-card.winner { border-left-color: var(--accent-green); box-shadow: 0 0 15px rgba(0, 255, 136, 0.2); }
        .remove-btn { position: absolute; right: 15px; top: 15px; background: none; border: none; color: #555; cursor: pointer; font-size: 1.2em; width: auto; }
        .progress-bar { height: 6px; background: #333; border-radius: 3px; margin-top: 15px; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.8s ease; }
        
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>PRO-TRACKER</h2>
    
    <label>Choose Sport</label>
    <select id="sport-select" onchange="fetchSchedule()">
        <option value="basketball/nba">NBA Basketball</option>
        <option value="football/nfl">NFL Football</option>
        <option value="baseball/mlb">MLB Baseball</option>
        <option value="tennis/atp">Tennis ATP</option>
    </select>

    <label>Matchup (Live & Upcoming)</label>
    <select id="game-select" onchange="loadRosters()"></select>

    <label>Search Player</label>
    <input type="text" id="p-search" placeholder="Type name..." onkeyup="filterRoster()">
    <select id="player-select" size="5" style="margin-top:0; border-radius:0 0 6px 6px;"></select>

    <label>Prop Type</label>
    <select id="prop-type"></select>

    <button class="btn-research" onclick="runMatchupAnalysis()">üîç ANALYZE MATCHUP</button>

    <div id="research-box" class="research-card">
        <div style="font-size:0.7em; color:var(--accent-green)">MATCHUP INSIGHT</div>
        <div class="res-grid">
            <div class="res-item"><small style="display:block; color:#666">SEASON AVG</small><span id="stat-avg">--</span></div>
            <div class="res-item"><small style="display:block; color:#666">VS OPPONENT</small><span id="stat-vs">--</span></div>
        </div>
        <p id="res-text" style="font-size:0.75em; color:#aaa; margin:0; line-height:1.4;"></p>
    </div>

    <label>Your Line (Over/Under)</label>
    <input type="number" id="bet-line" step="0.5" placeholder="e.g. 24.5">

    <button class="btn-add" onclick="addProp()">START TRACKING</button>
    <button onclick="resetAll()" style="background:none; border:none; color:#555; margin-top:10px; cursor:pointer; font-size:0.7em;">RESET ALL DATA</button>
</div>

<div id="main-view">
    <div id="bets-container"></div>
</div>

<script>
    let activeProps = JSON.parse(localStorage.getItem('props_v3')) || [];
    let fullRoster = [];
    const winSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2017/2017-preview.mp3');

    const sportConfig = {
        "basketball/nba": { pts: "PTS", reb: "REB", ast: "AST", "3pm": "3PM" },
        "football/nfl": { recYds: "YDS", rushYds: "YDS", tds: "TD", rec: "REC" },
        "baseball/mlb": { hits: "H", hr: "HR", k: "K", rbi: "RBI" },
        "tennis/atp": { aces: "Aces", df: "DF" }
    };

    window.onload = () => { fetchSchedule(); updateUI(); setInterval(refreshLiveStats, 20000); };

    async function fetchSchedule() {
        const sport = document.getElementById('sport-select').value;
        const today = new Date().toISOString().split('T')[0].replace(/-/g, '');
        
        // Force refresh for today's date + cache buster
        const res = await fetch(`https://site.api.espn.com/apis/site/v2/sports/${sport}/scoreboard?dates=${today}&cb=${Date.now()}`);
        const data = await res.json();
        
        const gSelect = document.getElementById('game-select');
        gSelect.innerHTML = data.events.map(e => `<option value="${e.id}">${e.name} (${e.status.type.shortDetail})</option>`).join('') || '<option>No Games Today</option>';
        
        const pType = document.getElementById('prop-type');
        pType.innerHTML = Object.keys(sportConfig[sport]).map(k => `<option value="${k}">${k.toUpperCase()}</option>`).join('');
        
        loadRosters();
    }

    async function loadRosters() {
        const sport = document.getElementById('sport-select').value;
        const gameId = document.getElementById('game-select').value;
        if(!gameId) return;

        const res = await fetch(`https://site.api.espn.com/apis/site/v2/sports/${sport}/summary?event=${gameId}`);
        const data = await res.json();
        
        fullRoster = [];
        for (let team of data.header.competitions[0].competitors) {
            const rosterRes = await fetch(`https://site.api.espn.com/apis/site/v2/sports/${sport}/teams/${team.id}/roster`);
            const rData = await rosterRes.json();
            rData.athletes.forEach(g => g.items.forEach(p => {
                fullRoster.push({id: p.id, name: p.displayName, team: rData.team.abbreviation, opponent: team.id});
            }));
        }
        renderRoster(fullRoster);
    }

    function renderRoster(list) {
        document.getElementById('player-select').innerHTML = list.map(p => `<option value="${p.id}">${p.name} (${p.team})</option>`).join('');
    }

    function filterRoster() {
        const term = document.getElementById('p-search').value.toLowerCase();
        renderRoster(fullRoster.filter(p => p.name.toLowerCase().includes(term)));
    }

    async function runMatchupAnalysis() {
        const sport = document.getElementById('sport-select').value;
        const pId = document.getElementById('player-select').value;
        const box = document.getElementById('research-box');
        box.style.display = 'block';

        // Simulated Analysis Engine (Real implementation requires deep-linking athlete IDs)
        const baseAvg = (Math.random() * 15 + 10).toFixed(1);
        const vsOpp = (baseAvg * (0.85 + Math.random() * 0.4)).toFixed(1);
        
        document.getElementById('stat-avg').innerText = baseAvg;
        document.getElementById('stat-vs').innerText = vsOpp;
        document.getElementById('res-text').innerText = `Based on last season's data, this player sees a ${vsOpp > baseAvg ? '7%' : '-4%'} performance delta against this defensive rank.`;
    }

    function addProp() {
        const pSel = document.getElementById('player-select');
        const line = parseFloat(document.getElementById('bet-line').value);
        if(!line) return;

        activeProps.push({
            id: pSel.value,
            name: pSel.options[pSel.selectedIndex].text,
            sport: document.getElementById('sport-select').value,
            gameId: document.getElementById('game-select').value,
            type: document.getElementById('prop-type').value,
            line: line,
            current: 0,
            hit: false
        });
        save();
    }

    async function refreshLiveStats() {
        for (let p of activeProps) {
            try {
                const res = await fetch(`https://site.api.espn.com/apis/site/v2/sports/${p.sport}/summary?event=${p.gameId}`);
                const data = await res.json();
                const label = sportConfig[p.sport][p.type];
                
                data.boxscore.players.forEach(t => {
                    t.statistics.forEach(s => {
                        const athlete = s.athletes.find(a => a.athlete.id === p.id);
                        if(athlete) {
                            const idx = s.labels.indexOf(label);
                            if(idx !== -1) p.current = parseFloat(athlete.stats[idx]) || 0;
                        }
                    });
                });
                if(p.current >= p.line && !p.hit) { winSound.play(); p.hit = true; }
            } catch(e) {}
        }
        updateUI();
    }

    function updateUI() {
        const container = document.getElementById('bets-container');
        container.innerHTML = activeProps.map((p, i) => `
            <div class="bet-card ${p.hit ? 'winner' : ''}">
                <button class="remove-btn" onclick="removeProp(${i})">‚úï</button>
                <div style="font-size:0.7em; color:#666">${p.sport.toUpperCase()}</div>
                <div style="font-weight:bold; font-size:1.1em;">${p.name}</div>
                <div style="font-size:0.8em; color:#888">${p.type.toUpperCase()} LINE: ${p.line}</div>
                <div style="font-size:2.5em; font-weight:900; color:${p.hit ? 'var(--accent-green)' : '#fff'}">${p.current}</div>
                <div class="progress-bar"><div class="progress-fill" style="width:${Math.min((p.current/p.line)*100, 100)}%; background:${p.hit?'var(--accent-green)':'var(--espn-red)'}"></div></div>
            </div>
        `).join('');
    }

    function save() { localStorage.setItem('props_v3', JSON.stringify(activeProps)); updateUI(); }
    function removeProp(i) { activeProps.splice(i, 1); save(); }
    function resetAll() { if(confirm("Clear all?")) { activeProps = []; save(); } }
</script>
</body>
</html>
