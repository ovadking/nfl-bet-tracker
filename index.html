<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Prop Tracker v17 - Parlay Master</title>
    <style>
        :root { --red: #ff3e3e; --bg: #0a0a0a; --card: #181818; --green: #00ff88; --text: #ffffff; --yellow: #ffcc00; --gold: #ffd700; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        #sidebar { width: 380px; background: var(--card); padding: 20px; border-right: 1px solid #333; overflow-y: auto; }
        h2 { color: var(--red); font-size: 1.1rem; margin-bottom: 20px; letter-spacing: 2px; }
        label { font-size: 0.6rem; color: #777; font-weight: 800; margin-top: 12px; display: block; text-transform: uppercase; }
        select, input, button { width: 100%; padding: 10px; margin-top: 5px; border-radius: 8px; border: 1px solid #333; background: #222; color: #fff; font-size: 0.85rem; box-sizing: border-box; }
        .parlay-builder { background: #111; padding: 15px; border-radius: 12px; border: 1px dashed #444; margin-top: 15px; }
        .btn-add-leg { background: #333; color: var(--green); border: 1px solid var(--green); cursor: pointer; margin-bottom: 10px; font-weight: bold; }
        .btn-finalize { background: var(--green); color: #000; border: none; font-weight: 900; cursor: pointer; height: 45px; }
        #main { flex-grow: 1; padding: 30px; overflow-y: auto; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 25px; }
        .parlay-card { background: var(--card); border-radius: 16px; border: 2px solid #333; overflow: hidden; position: relative; }
        .parlay-card.complete { border-color: var(--gold); box-shadow: 0 0 30px rgba(255, 215, 0, 0.3); }
        .parlay-header { background: #222; padding: 12px 20px; font-weight: 900; font-size: 0.8rem; display: flex; justify-content: space-between; }
        .leg { padding: 15px 20px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
        .leg.hit { background: rgba(0, 255, 136, 0.05); }
        .leg-name { font-weight: bold; font-size: 0.9rem; }
        .leg-stats { text-align: right; }
        .check { color: var(--green); font-weight: bold; margin-left: 10px; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>PARLAY TRACKER v17</h2>
    
    <button onclick="Notification.requestPermission()" style="background:var(--yellow); color:#000; font-weight:bold; margin-bottom:20px;">ðŸ”” ACTIVATE ALERTS</button>

    <div class="parlay-builder">
        <div style="color:var(--yellow); font-weight:bold; font-size:0.7rem; margin-bottom:10px;">BUILD NEW PARLAY</div>
        <label>Sport</label>
        <select id="sport" onchange="fetchGames()"><option value="basketball/nba">NBA</option><option value="football/nfl">NFL</option></select>
        <label>Game</label>
        <select id="game-select" onchange="fetchRoster()"></select>
        <label>Player</label>
        <select id="player-select"></select>
        <label>Target</label>
        <div style="display:flex; gap:5px;">
            <select id="stat-type" style="flex:1;"><option value="PTS">Points</option><option value="REB">Rebounds</option><option value="AST">Assists</option></select>
            <input type="number" id="target-val" step="0.5" placeholder="Line" style="flex:1;">
        </div>
        <button class="btn-add-leg" onclick="addLegToDraft()">+ ADD LEG TO PARLAY</button>
        
        <div id="draft-list" style="font-size:0.7rem; color:#aaa; margin:10px 0;"></div>
        <button class="btn-finalize" onclick="finalizeParlay()">ðŸš€ DEPLOY PARLAY</button>
    </div>
</div>

<div id="main"><div id="parlay-grid" class="grid"></div></div>

<script>
    let activeParlays = JSON.parse(localStorage.getItem('parlays_v17')) || [];
    let draftLegs = [];

    async function fetchGames() {
        const s = document.getElementById('sport').value;
        const res = await fetch(`https://site.api.espn.com/apis/site/v2/sports/${s}/scoreboard`);
        const data = await res.json();
        document.getElementById('game-select').innerHTML = data.events.map(e => `<option value="${e.id}">${e.shortName}</option>`).join('');
        fetchRoster();
    }

    async function fetchRoster() {
        const s = document.getElementById('sport').value;
        const g = document.getElementById('game-select').value;
        const res = await fetch(`https://site.api.espn.com/apis/site/v2/sports/${s}/summary?event=${g}`);
        const data = await res.json();
        let p = [];
        data.boxscore?.players?.forEach(t => t.statistics[0].athletes.forEach(a => p.push({id: a.athlete.id, name: a.athlete.displayName})));
        document.getElementById('player-select').innerHTML = p.map(x => `<option value="${x.id}">${x.name}</option>`).join('');
    }

    function addLegToDraft() {
        const p = document.getElementById('player-select');
        draftLegs.push({
            id: p.value,
            name: p.options[p.selectedIndex].text,
            sport: document.getElementById('sport').value,
            gameId: document.getElementById('game-select').value,
            type: document.getElementById('stat-type').value,
            target: parseFloat(document.getElementById('target-val').value),
            current: 0, hit: false
        });
        document.getElementById('draft-list').innerHTML = draftLegs.map(l => `<div>â€¢ ${l.name} ${l.target} ${l.type}</div>`).join('');
    }

    function finalizeParlay() {
        if(draftLegs.length < 1) return;
        activeParlays.push({ id: Date.now(), legs: [...draftLegs], won: false });
        draftLegs = [];
        document.getElementById('draft-list').innerHTML = "";
        save();
    }

    async function updateStats() {
        for (let parlay of activeParlays) {
            let allHit = true;
            for (let leg of parlay.legs) {
                try {
                    const res = await fetch(`https://site.api.espn.com/apis/site/v2/sports/${leg.sport}/summary?event=${leg.gameId}`);
                    const data = await res.json();
                    data.boxscore?.players?.forEach(t => {
                        const stats = t.statistics[0];
                        const athlete = stats.athletes.find(a => a.athlete.id === leg.id);
                        if (athlete) {
                            const idx = stats.labels.indexOf(leg.type);
                            leg.current = parseFloat(athlete.stats[idx]) || 0;
                            if (leg.current >= leg.target) leg.hit = true;
                        }
                    });
                } catch(e){}
                if(!leg.hit) allHit = false;
            }
            if(allHit && !parlay.won) {
                parlay.won = true;
                new Notification("ðŸ’° PARLAY HIT!", { body: "All legs have cleared! Collect your green." });
            }
        }
        render();
    }

    function render() {
        document.getElementById('parlay-grid').innerHTML = activeParlays.map((parlay, idx) => `
            <div class="parlay-card ${parlay.won ? 'complete' : ''}">
                <div class="parlay-header">
                    <span>${parlay.legs.length}-LEG PARLAY</span>
                    <button onclick="removeParlay(${idx})" style="width:auto; padding:0; background:none; border:none; color:#555; cursor:pointer;">REMOVE</button>
                </div>
                ${parlay.legs.map(l => `
                    <div class="leg ${l.hit ? 'hit' : ''}">
                        <div>
                            <div class="leg-name">${l.name}</div>
                            <div style="font-size:0.6rem; color:#666;">${l.target} ${l.type}</div>
                        </div>
                        <div class="leg-stats">
                            <span style="font-size:1.2rem; font-weight:900; color:${l.hit ? 'var(--green)' : '#fff'}">${l.current}</span>
                            ${l.hit ? '<span class="check">âœ“</span>' : ''}
                        </div>
                    </div>
                `).join('')}
            </div>
        `).join('');
    }

    function save() { localStorage.setItem('parlays_v17', JSON.stringify(activeParlays)); render(); }
    function removeParlay(i) { activeParlays.splice(i, 1); save(); }

    fetchGames();
    setInterval(updateStats, 20000);
</script>
</body>
</html>
