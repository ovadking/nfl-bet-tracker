<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFL Pro-Tracker | Live Stats & Search</title>
    <style>
        :root {
            --espn-red: #cc0000;
            --dark-bg: #0f0f0f;
            --card-bg: #1a1a1a;
            --accent-green: #00ff88;
            --text-main: #e0e0e0;
            --input-bg: #2a2a2a;
        }

        [data-theme="light"] {
            --dark-bg: #f4f4f4;
            --card-bg: #ffffff;
            --text-main: #1a1a1a;
            --input-bg: #eeeeee;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--dark-bg);
            color: var(--text-main);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            transition: background 0.3s ease;
        }

        #sidebar {
            width: 350px;
            background-color: var(--card-bg);
            padding: 25px;
            border-right: 1px solid #444;
            overflow-y: auto;
            z-index: 10;
            display: flex;
            flex-direction: column;
        }

        #live-stats {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .summary-banner {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-around;
            border: 1px solid #444;
        }

        .summary-stat { text-align: center; }
        .summary-stat span { display: block; font-size: 1.5em; font-weight: bold; }

        .bet-card {
            background: var(--input-bg);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 6px solid var(--espn-red);
            position: relative;
        }

        .bet-card.winner {
            border-left-color: var(--accent-green);
            background: rgba(0, 255, 136, 0.05);
        }

        .search-input {
            background: #111;
            border: 1px solid var(--espn-red);
            font-size: 0.85em;
            padding: 8px;
            margin-bottom: 0;
            border-radius: 6px 6px 0 0;
        }

        .player-select-box {
            border-radius: 0 0 6px 6px !important;
            margin-top: 0 !important;
        }

        label { display: block; margin-top: 15px; font-size: 0.75em; color: #888; text-transform: uppercase; font-weight: bold; }
        
        select, input, button {
            width: 100%; padding: 12px; margin-top: 5px;
            border-radius: 6px; border: 1px solid #444;
            background: var(--input-bg); color: var(--text-main);
            box-sizing: border-box;
        }

        button { background: var(--espn-red); color: white; border: none; font-weight: bold; cursor: pointer; margin-top: 20px; }
        
        .progress-container { height: 8px; background: #333; border-radius: 4px; margin-top: 15px; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 1s ease; }

        .winner-badge {
            background: var(--accent-green); color: black;
            font-size: 0.7em; padding: 2px 8px; border-radius: 10px; margin-left: 10px;
        }
    </style>
</head>
<body>

<div id="sidebar">
    <h2 style="color:var(--espn-red); margin-top:0;">NFL TRACKER</h2>
    
    <label>1. Select Game</label>
    <select id="game-select" onchange="loadPlayers()"></select>

    <label>2. Search & Select Player</label>
    <input type="text" id="player-search" class="search-input" placeholder="Type name to filter..." onkeyup="filterPlayers()">
    <select id="player-select" class="player-select-box" size="5"></select>

    <label>3. Category</label>
    <select id="stat-category">
        <option value="rushingYards">Rushing Yards</option>
        <option value="passingYards">Passing Yards</option>
        <option value="receivingYards">Receiving Yards</option>
        <option value="receptions">Receptions</option>
    </select>

    <label>4. Your Line</label>
    <input type="number" id="bet-line" step="0.5" placeholder="e.g. 75.5">

    <button onclick="addBet()">TRACK PROP</button>
    <div id="last-update" style="font-size: 0.7em; color: #666; margin-top: 20px; text-align: center;">Syncing...</div>
</div>

<div id="live-stats">
    <div class="summary-banner" id="win-loss-banner">
        <div class="summary-stat">WINS <span id="total-wins" style="color:var(--accent-green)">0</span></div>
        <div class="summary-stat">ACTIVE <span id="total-active">0</span></div>
        <div class="summary-stat">TOTAL <span id="total-bets">0</span></div>
    </div>
    <div id="bets-container"></div>
</div>

<script>
    let myBets = JSON.parse(localStorage.getItem('nfl_bets')) || [];
    let fullRoster = []; // Holds current game roster for searching
    const BASE_URL = "https://site.api.espn.com/apis/site/v2/sports/football/nfl";
    const winSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2017/2017-preview.mp3');

    window.onload = () => {
        fetchGames();
        updateUI();
        refreshStats();
    };

    async function fetchGames() {
        try {
            const res = await fetch(`${BASE_URL}/scoreboard`);
            const data = await res.json();
            const select = document.getElementById('game-select');
            select.innerHTML = '<option value="">-- Select Game --</option>';
            data.events.forEach(e => {
                select.innerHTML += `<option value="${e.id}">${e.name} (${e.status.type.shortDetail})</option>`;
            });
        } catch (e) { console.error(e); }
    }

    async function loadPlayers() {
        const gameId = document.getElementById('game-select').value;
        const playerSelect = document.getElementById('player-select');
        playerSelect.innerHTML = '<option>Loading...</option>';
        
        try {
            const summaryRes = await fetch(`${BASE_URL}/summary?event=${gameId}`);
            const summaryData = await summaryRes.json();
            const teamIds = summaryData.header.competitions[0].competitors.map(c => c.id);

            fullRoster = [];
            for (let id of teamIds) {
                const rosterRes = await fetch(`${BASE_URL}/teams/${id}/roster`);
                const rosterData = await rosterRes.json();
                rosterData.athletes.forEach(g => g.items.forEach(p => {
                    fullRoster.push({id: p.id, name: p.displayName, team: rosterData.team.abbreviation});
                }));
            }
            fullRoster.sort((a,b) => a.name.localeCompare(b.name));
            renderPlayerList(fullRoster);
        } catch(e) { playerSelect.innerHTML = '<option>Error loading</option>'; }
    }

    function renderPlayerList(list) {
        const playerSelect = document.getElementById('player-select');
        playerSelect.innerHTML = '';
        list.forEach(p => {
            playerSelect.innerHTML += `<option value="${p.id}">${p.name} (${p.team})</option>`;
        });
    }

    function filterPlayers() {
        const term = document.getElementById('player-search').value.toLowerCase();
        const filtered = fullRoster.filter(p => p.name.toLowerCase().includes(term));
        renderPlayerList(filtered);
    }

    function addBet() {
        const gameId = document.getElementById('game-select').value;
        const playerSelect = document.getElementById('player-select');
        const playerId = playerSelect.value;
        const playerName = playerSelect.options[playerSelect.selectedIndex]?.text;
        const category = document.getElementById('stat-category').value;
        const line = parseFloat(document.getElementById('bet-line').value);

        if(!gameId || !playerId || isNaN(line)) return alert("Please select a game, player, and line.");

        myBets.push({ gameId, playerId, playerName, category, line, currentStat: 0, hasAlerted: false, gameStatus: 'Live' });
        saveAndRefresh();
    }

    async function refreshStats() {
        for (let bet of myBets) {
            try {
                const res = await fetch(`${BASE_URL}/summary?event=${bet.gameId}`);
                const data = await res.json();
                bet.gameStatus = data.header.competitions[0].status.type.shortDetail;
                if(data.situation) bet.lastPlay = data.situation.lastPlay?.text || "";

                let val = 0;
                data.boxscore.players.forEach(team => {
                    team.statistics.forEach(group => {
                        const athlete = group.athletes.find(a => a.athlete.id === bet.playerId);
                        if(athlete) {
                            const idx = group.labels.indexOf(getLabel(bet.category));
                            if(idx !== -1) val = parseFloat(athlete.stats[idx].toString().split('/')[0]) || 0;
                        }
                    });
                });
                if(val >= bet.line && !bet.hasAlerted) { winSound.play().catch(e => {}); bet.hasAlerted = true; }
                bet.currentStat = val;
            } catch (e) {}
        }
        saveAndRefresh();
    }

    function getLabel(cat) { return {rushingYards:"YDS", passingYards:"YDS", receivingYards:"YDS", receptions:"REC"}[cat]; }

    function saveAndRefresh() {
        localStorage.setItem('nfl_bets', JSON.stringify(myBets));
        updateUI();
    }

    function updateUI() {
        const container = document.getElementById('bets-container');
        container.innerHTML = '';
        
        let wins = 0;
        myBets.forEach((b, i) => {
            const isOver = b.currentStat >= b.line;
            if(isOver) wins++;
            
            container.innerHTML += `
                <div class="bet-card ${isOver ? 'winner' : ''}">
                    <button class="remove-btn" onclick="removeBet(${i})">âœ•</button>
                    <div class="game-info-bar">${b.gameStatus}</div>
                    <div style="font-weight:bold">${b.playerName} ${isOver ? '<span class="winner-badge">WINNER</span>' : ''}</div>
                    <div style="font-size:0.8em; color:#888">${b.category.toUpperCase()} | LINE: ${b.line}</div>
                    <div class="stat-value">${b.currentStat}</div>
                    <div class="progress-container"><div class="progress-fill" style="width:${Math.min((b.currentStat/b.line)*100, 100)}%; background:${isOver ? 'var(--accent-green)' : 'var(--espn-red)'}"></div></div>
                </div>`;
        });

        document.getElementById('total-wins').textContent = wins;
        document.getElementById('total-active').textContent = myBets.length - wins;
        document.getElementById('total-bets').textContent = myBets.length;
    }

    function removeBet(i) { myBets.splice(i, 1); saveAndRefresh(); }
    setInterval(refreshStats, 30000);
</script>
</body>
</html>
